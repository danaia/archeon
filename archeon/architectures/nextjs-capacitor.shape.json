{
  "meta": {
    "id": "nextjs-capacitor",
    "name": "Next.js 14 + React + Capacitor (Near-Native Mobile)",
    "description": "Near-native mobile app using Next.js App Router wrapped with Capacitor, offline-first, plugin-gated IO",
    "version": "1.0.0",
    "tags": ["mobile", "capacitor", "nextjs", "react", "offline-first"]
  },

  "architecture": {
    "summary": "A mobile-first architecture that wraps a Next.js 14 web app with Capacitor to deploy as native iOS and Android applications. Uses static export for compatibility with Capacitor's webview runtime.",
    "layers": [
      {
        "name": "UI Layer (CMP)",
        "description": "React components that are purely presentational. Components NEVER access native APIs, HTTP, or databases directly. They receive data via props and emit events upward.",
        "rules": ["No direct IO", "No Capacitor plugin imports", "No fetch/axios calls", "State comes from STO via hooks"]
      },
      {
        "name": "State Layer (STO)", 
        "description": "Zustand stores that manage application state and orchestrate data flow. Stores call Services (SVC) for business logic but never call native plugins directly.",
        "rules": ["Single source of truth", "Calls SVC for async operations", "Never imports Capacitor plugins"]
      },
      {
        "name": "Service Layer (SVC)",
        "description": "Business logic orchestrators that coordinate between Adapters and Plugins. Services know WHAT to do but delegate HOW to adapters/plugins.",
        "rules": ["Orchestrates adapters and plugins", "Contains business logic", "Returns promises"]
      },
      {
        "name": "Adapter Layer (ADP)",
        "description": "HTTP and cache boundary. All network requests go through adapters. Handles API calls, caching strategies, and offline queue.",
        "rules": ["Wraps fetch/axios", "Implements caching", "Handles offline queue"]
      },
      {
        "name": "Plugin Layer (PLUG)",
        "description": "Capacitor native plugin wrappers. Each plugin wrapper isolates a single native capability (camera, filesystem, etc). Handles permissions and platform differences.",
        "rules": ["One plugin per file", "Handles permissions", "Platform-specific fallbacks"]
      }
    ],
    "dataFlow": "CMP -> STO -> SVC -> (ADP | PLUG) -> Native/HTTP",
    "keyPrinciples": [
      "UI components are dumb - no business logic or IO",
      "State stores orchestrate but don't perform IO directly", 
      "Services coordinate adapters and plugins",
      "All native access goes through PLUG wrappers",
      "All HTTP access goes through ADP adapters",
      "Static export required for Capacitor compatibility"
    ],
    "offlineStrategy": "Offline-first with local cache. SVC layer checks network status and routes to cache or HTTP. Queue operations when offline, sync when online.",
    "buildProcess": "Next.js builds to static HTML/JS/CSS in 'out/' folder. Capacitor syncs this to native iOS/Android projects which embed it in a webview."
  },

  "defaultChain": "@v1 NED:system.ready => ARC:nextjs-capacitor => OUT:installed",

  "stack": {
    "frontend": {
      "framework": "nextjs",
      "version": "14.x",
      "language": "typescript",
      "runtime": "capacitor",
      "stateManager": "zustand",
      "styling": "tailwindcss",
      "router": "app-router"
    },
    "platform": {
      "wrapper": "capacitor",
      "targets": ["ios", "android"],
      "plugins": [
        "camera",
        "filesystem",
        "preferences",
        "push-notifications",
        "haptics",
        "device",
        "network"
      ]
    }
  },

  "directories": {
    "client": {
      "src": {
        "app": {},
        "components": {},
        "features": {},
        "stores": {},
        "services": {},
        "adapters": {},
        "platform": {
          "plugins": {},
          "permissions": {}
        },
        "lib": {
          "http": {},
          "cache": {},
          "utils": {}
        },
        "types": {}
      },
      "public": {},
      "ios": {
        "_note": "Generated by Capacitor - native iOS project"
      },
      "android": {
        "_note": "Generated by Capacitor - native Android project"
      }
    }
  },

  "files": {
    "client/package.json": "{\n  \"name\": \"capacitor-app\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\",\n    \"cap:sync\": \"npx cap sync\",\n    \"cap:open:ios\": \"npx cap open ios\",\n    \"cap:open:android\": \"npx cap open android\",\n    \"cap:run:ios\": \"npx cap run ios\",\n    \"cap:run:android\": \"npx cap run android\",\n    \"build:mobile\": \"next build && npx cap sync\"\n  },\n  \"dependencies\": {\n    \"next\": \"^14.0.0\",\n    \"react\": \"^18.2.0\",\n    \"react-dom\": \"^18.2.0\",\n    \"zustand\": \"^4.4.0\",\n    \"@capacitor/core\": \"^6.0.0\",\n    \"@capacitor/camera\": \"^6.0.0\",\n    \"@capacitor/filesystem\": \"^6.0.0\",\n    \"@capacitor/preferences\": \"^6.0.0\",\n    \"@capacitor/push-notifications\": \"^6.0.0\",\n    \"@capacitor/haptics\": \"^6.0.0\",\n    \"@capacitor/device\": \"^6.0.0\",\n    \"@capacitor/network\": \"^6.0.0\",\n    \"tailwindcss\": \"^3.4.0\",\n    \"clsx\": \"^2.0.0\",\n    \"tailwind-merge\": \"^2.0.0\"\n  },\n  \"devDependencies\": {\n    \"@capacitor/cli\": \"^6.0.0\",\n    \"@capacitor/ios\": \"^6.0.0\",\n    \"@capacitor/android\": \"^6.0.0\",\n    \"@types/node\": \"^20.0.0\",\n    \"@types/react\": \"^18.2.0\",\n    \"@types/react-dom\": \"^18.2.0\",\n    \"typescript\": \"^5.0.0\",\n    \"autoprefixer\": \"^10.4.0\",\n    \"postcss\": \"^8.4.0\"\n  }\n}",
    "client/capacitor.config.ts": "import type { CapacitorConfig } from '@capacitor/cli';\n\nconst config: CapacitorConfig = {\n  appId: 'com.example.app',\n  appName: 'Capacitor App',\n  webDir: 'out',\n  server: {\n    androidScheme: 'https'\n  },\n  plugins: {\n    PushNotifications: {\n      presentationOptions: ['badge', 'sound', 'alert']\n    },\n    SplashScreen: {\n      launchShowDuration: 2000,\n      backgroundColor: '#ffffff',\n      showSpinner: false\n    }\n  }\n};\n\nexport default config;",
    "client/next.config.js": "/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  output: 'export',\n  images: {\n    unoptimized: true\n  },\n  trailingSlash: true\n};\n\nmodule.exports = nextConfig;",
    "client/tsconfig.json": "{\n  \"compilerOptions\": {\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [{ \"name\": \"next\" }],\n    \"paths\": {\n      \"@/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\", \"ios\", \"android\"]\n}",
    "client/tailwind.config.ts": "import type { Config } from 'tailwindcss';\n\nconst config: Config = {\n  content: [\n    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',\n    './src/components/**/*.{js,ts,jsx,tsx,mdx}',\n    './src/app/**/*.{js,ts,jsx,tsx,mdx}',\n    './src/features/**/*.{js,ts,jsx,tsx,mdx}'\n  ],\n  theme: {\n    extend: {\n      colors: {\n        // Mobile-friendly touch targets\n      },\n      spacing: {\n        'safe-top': 'env(safe-area-inset-top)',\n        'safe-bottom': 'env(safe-area-inset-bottom)',\n        'safe-left': 'env(safe-area-inset-left)',\n        'safe-right': 'env(safe-area-inset-right)'\n      }\n    }\n  },\n  plugins: []\n};\n\nexport default config;",
    "client/postcss.config.js": "module.exports = {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {}\n  }\n};",
    "client/src/app/layout.tsx": "import type { Metadata, Viewport } from 'next';\nimport { Inter } from 'next/font/google';\nimport './globals.css';\n\nconst inter = Inter({ subsets: ['latin'] });\n\nexport const metadata: Metadata = {\n  title: 'Capacitor App',\n  description: 'Built with Next.js and Capacitor',\n  appleWebApp: {\n    capable: true,\n    statusBarStyle: 'default',\n    title: 'Capacitor App'\n  },\n  formatDetection: {\n    telephone: false\n  }\n};\n\nexport const viewport: Viewport = {\n  width: 'device-width',\n  initialScale: 1,\n  maximumScale: 1,\n  userScalable: false,\n  viewportFit: 'cover'\n};\n\nexport default function RootLayout({\n  children\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <html lang=\"en\">\n      <body className={inter.className}>\n        <main className=\"min-h-screen pt-safe-top pb-safe-bottom px-safe-left pr-safe-right\">\n          {children}\n        </main>\n      </body>\n    </html>\n  );\n}",
    "client/src/app/page.tsx": "'use client';\n\nexport default function Home() {\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-screen p-4\">\n      <h1 className=\"text-2xl font-bold mb-4\">Welcome to Capacitor App</h1>\n      <p className=\"text-gray-600 text-center\">\n        Edit src/app/page.tsx to get started\n      </p>\n    </div>\n  );\n}",
    "client/src/app/globals.css": "@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --foreground-rgb: 0, 0, 0;\n  --background-rgb: 255, 255, 255;\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --foreground-rgb: 255, 255, 255;\n    --background-rgb: 0, 0, 0;\n  }\n}\n\nbody {\n  color: rgb(var(--foreground-rgb));\n  background: rgb(var(--background-rgb));\n  /* Prevent pull-to-refresh on mobile */\n  overscroll-behavior: none;\n  /* Smooth scrolling */\n  -webkit-overflow-scrolling: touch;\n}",
    "client/src/lib/utils.ts": "import { clsx, type ClassValue } from 'clsx';\nimport { twMerge } from 'tailwind-merge';\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}",
    "client/src/platform/plugins/capacitor.ts": "// @archeon:file\n// @glyph PLUG:Capacitor\n// @intent Capacitor platform detection and initialization\n\nimport { Capacitor } from '@capacitor/core';\n\nexport const isNative = Capacitor.isNativePlatform();\nexport const platform = Capacitor.getPlatform(); // 'ios' | 'android' | 'web'\n\nexport function isIOS(): boolean {\n  return platform === 'ios';\n}\n\nexport function isAndroid(): boolean {\n  return platform === 'android';\n}\n\nexport function isWeb(): boolean {\n  return platform === 'web';\n}",
    "client/src/platform/plugins/network.ts": "// @archeon:file\n// @glyph PLUG:Network\n// @intent Network status detection for offline-first support\n\nimport { Network, ConnectionStatus } from '@capacitor/network';\n\nlet currentStatus: ConnectionStatus | null = null;\n\nexport async function getNetworkStatus(): Promise<ConnectionStatus> {\n  if (currentStatus) return currentStatus;\n  currentStatus = await Network.getStatus();\n  return currentStatus;\n}\n\nexport async function isOnline(): Promise<boolean> {\n  const status = await getNetworkStatus();\n  return status.connected;\n}\n\nexport function onNetworkChange(callback: (status: ConnectionStatus) => void): () => void {\n  const listener = Network.addListener('networkStatusChange', (status) => {\n    currentStatus = status;\n    callback(status);\n  });\n  \n  return () => listener.remove();\n}"
  },

  "glyphs": {
    "CMP": {
      "description": "React component (UI only, no IO)",
      "layer": "frontend",
      "output": {
        "directory": "client/src/components",
        "extension": ".tsx",
        "naming": "PascalCase"
      },
      "sections": ["imports", "types", "component", "exports"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n// @intent {INTENT}\n// @chain {CHAIN}\n\n'use client';\n\n// @archeon:section imports\nimport { cn } from '@/lib/utils';\n{IMPORTS}\n// @archeon:endsection\n\n// @archeon:section types\ninterface {NAME}Props {\n  className?: string;\n  {PROPS}\n}\n// @archeon:endsection\n\n// @archeon:section component\nexport function {NAME}({ className, {PROP_NAMES} }: {NAME}Props) {\n  return (\n    <div className={cn('', className)}>\n      {CONTENT}\n    </div>\n  );\n}\n// @archeon:endsection",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "INTENT": { "default": "UI Component" },
        "CHAIN": { "default": "@v1" },
        "NAME": { "required": true },
        "IMPORTS": { "default": "" },
        "PROPS": { "default": "" },
        "PROP_NAMES": { "default": "" },
        "CONTENT": { "default": "" }
      }
    },

    "STO": {
      "description": "Zustand store (state + orchestration only)",
      "layer": "frontend",
      "output": {
        "directory": "client/src/stores",
        "extension": ".ts",
        "naming": "camelCase"
      },
      "sections": ["imports", "types", "store"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n// @intent {INTENT}\n// @chain {CHAIN}\n\nimport { create } from 'zustand';\n\ninterface {NAME}State {\n  {STATE}\n}\n\ninterface {NAME}Actions {\n  {ACTIONS}\n}\n\nexport const use{NAME}Store = create<{NAME}State & {NAME}Actions>((set, get) => ({\n  {INITIAL_STATE}\n  {IMPLEMENTATIONS}\n}));",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "NAME": { "required": true },
        "STATE": { "default": "" },
        "ACTIONS": { "default": "" },
        "INITIAL_STATE": { "default": "" },
        "IMPLEMENTATIONS": { "default": "" }
      }
    },

    "SVC": {
      "description": "Service / use-case orchestrator",
      "layer": "frontend",
      "output": {
        "directory": "client/src/services",
        "extension": ".ts",
        "naming": "camelCase"
      },
      "sections": ["imports", "service"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n// @intent {INTENT}\n\nimport { networkAdapter } from '@/adapters/networkAdapter';\n\nexport async function {FUNCTION_NAME}() {\n  {IMPLEMENTATION}\n}",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "FUNCTION_NAME": { "required": true },
        "IMPLEMENTATION": { "default": "" }
      }
    },

    "ADP": {
      "description": "Adapter (HTTP / cache boundary)",
      "layer": "frontend",
      "output": {
        "directory": "client/src/adapters",
        "extension": ".ts",
        "naming": "camelCase"
      },
      "sections": ["imports", "adapter"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n\nexport const {NAME}Adapter = {\n  async fetch() {\n    {IMPLEMENTATION}\n  }\n};",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "NAME": { "required": true },
        "IMPLEMENTATION": { "default": "" }
      }
    },

    "PLUG": {
      "description": "Capacitor plugin wrapper",
      "layer": "frontend",
      "output": {
        "directory": "client/src/platform/plugins",
        "extension": ".ts",
        "naming": "camelCase"
      },
      "sections": ["imports", "plugin"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n\nimport { Camera } from '@capacitor/camera';\n\nexport async function {FUNCTION_NAME}() {\n  return Camera.getPhoto({ resultType: 'uri' });\n}",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "FUNCTION_NAME": { "required": true }
      }
    },

    "OUT": {
      "description": "Observable UI outcome",
      "layer": "frontend",
      "output": {
        "directory": "client/src/lib/outcomes",
        "extension": ".ts",
        "naming": "camelCase"
      },
      "sections": ["outcome"],
      "snippet": "// @archeon:file\n// @glyph {GLYPH_NAME}\n\nexport function {FUNCTION_NAME}() {\n  {IMPLEMENTATION}\n}",
      "placeholders": {
        "GLYPH_NAME": { "required": true },
        "FUNCTION_NAME": { "required": true },
        "IMPLEMENTATION": { "default": "" }
      }
    }
  },

  "constraints": {
    "forbidden": [
      "CMP -> ADP",
      "CMP -> PLUG",
      "CMP -> HTTP",
      "CMP -> DB",
      "STO -> PLUG",
      "CMP -> SVC"
    ]
  },

  "dependencies": {
    "client": {
      "next": "^14.0.0",
      "react": "^18.2.0",
      "react-dom": "^18.2.0",
      "zustand": "^4.4.0",
      "@capacitor/core": "^6.0.0",
      "@capacitor/camera": "^6.0.0",
      "@capacitor/filesystem": "^6.0.0",
      "@capacitor/preferences": "^6.0.0",
      "@capacitor/push-notifications": "^6.0.0",
      "@capacitor/haptics": "^6.0.0",
      "@capacitor/device": "^6.0.0",
      "@capacitor/network": "^6.0.0"
    },
    "devDependencies": {
      "@capacitor/cli": "^6.0.0",
      "@capacitor/ios": "^6.0.0",
      "@capacitor/android": "^6.0.0"
    }
  },

  "setup": {
    "commands": [
      "npm install",
      "npx cap init {PROJECT_NAME} com.{PROJECT_NAME}.app --web-dir=out",
      "npx cap add ios",
      "npx cap add android",
      "npm run build",
      "npx cap sync"
    ],
    "notes": [
      "Capacitor requires static export - next.config.js is configured with output: 'export'",
      "Run 'npx cap open ios' to open Xcode project",
      "Run 'npx cap open android' to open Android Studio project",
      "iOS requires Xcode and CocoaPods installed",
      "Android requires Android Studio with SDK tools"
    ]
  }
}
